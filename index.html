<!doctype html>
<html>

<head>
    <style>
        body {
            background-color: #6F6F6E;
            font: arial;
        }

        svg {
            display: inline-block;
        }

        polyline {
            opacity: 0.5;
        }

        .clickedBar {
            fill: black;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <body>
        <div id="myGraph"></div>
        <svg width="800" height="500"></svg>
        <script>
            if (!Array.prototype.last) {
                Array.prototype.last = function () {
                    return this[this.length - 1];
                };
            };

            const rawData = [
                { bugId: "77045", LTPrisEnCharge: 164, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "77829", LTPrisEnCharge: 206, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78287", LTPrisEnCharge: 64, LTCorrection: 77, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78478", LTPrisEnCharge: 106, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78593", LTPrisEnCharge: 81, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78624", LTPrisEnCharge: 63, LTCorrection: 12, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78643", LTPrisEnCharge: 61, LTCorrection: 11, LTValidation: 15, seuilMax: 100, seuilMin: 21 },
                { bugId: "78685", LTPrisEnCharge: 11, LTCorrection: 55, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78713", LTPrisEnCharge: 61, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78805", LTPrisEnCharge: 40, LTCorrection: 10, LTValidation: 30, seuilMax: 100, seuilMin: 21 },
                { bugId: "78823", LTPrisEnCharge: 27, LTCorrection: 18, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78848", LTPrisEnCharge: 42, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78901", LTPrisEnCharge: 31, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78908", LTPrisEnCharge: 21, LTCorrection: 10, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78934", LTPrisEnCharge: 26, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78936", LTPrisEnCharge: 16, LTCorrection: 11, LTValidation: 0, seuilMax: 30, seuilMin: 7 },
                { bugId: "78940", LTPrisEnCharge: 15, LTCorrection: 11, LTValidation: 0, seuilMax: 30, seuilMin: 7 },
                { bugId: "78964", LTPrisEnCharge: 21, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78979", LTPrisEnCharge: 10, LTCorrection: 10, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "78999", LTPrisEnCharge: 7, LTCorrection: 11, LTValidation: 0, seuilMax: 30, seuilMin: 7 },
                { bugId: "79000", LTPrisEnCharge: 17, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "79019", LTPrisEnCharge: 6, LTCorrection: 10, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "79029", LTPrisEnCharge: 13, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 },
                { bugId: "79049", LTPrisEnCharge: 19, LTCorrection: 0, LTValidation: 0, seuilMax: 100, seuilMin: 21 }
            ];

            function formatData(data) {
                return data.map(item =>
                    ({
                        x: item.bugId,
                        y: {
                            bar: [
                                item.LTPrisEnCharge,
                                item.LTCorrection,
                                item.LTValidation
                            ],
                            lines: [item.seuilMax, item.seuilMin]
                        }
                    })
                );
            }

            var cfg = {
                data: formatData(rawData),  //{ x, y:{ bars:[], lines:[] } }
                title: "Modaris - Lead Time R&D - Bugs en cours:",
                colors: { prisEnCharge: "#BE1622", correction: "#C5C4C5", validation: "#878787", seuilMin: "#0000FF", seuilMax: "#FFFF00" }
            };

            //var selectedBar = "15"; 

            console.log(cfg.data);

            const paddingRatio = 0.4;
            var svg = d3.select("svg"),
                margin = 200,
                width = svg.attr("width") - margin,
                height = svg.attr("height") - margin,
                xScale = d3.scaleBand().range([0, width]).padding(paddingRatio),
                yScale = d3.scaleLinear().range([height, 0])
                ;

            function computeMaxJours(d) {
                const barMax = d.y.bar.reduce((accu, item) => accu + item, 0);
                const linesMax = Math.max(...(d.y.lines));
                return Math.max(barMax, linesMax);
            }

            xScale.domain(cfg.data.map(item => item.x));
            yScale.domain([0, d3.max(cfg.data, computeMaxJours)]);

            function setColor(d, index) {
                Object.keys(cfg.colors)
                return cfg.colors[Object.keys(cfg.colors)[index]];
            }

            function removeRedondancy(data, selectParameter) {
                var accuInit = { points: [], lastSeuilMax: 0, lastSeuilMin: 0, lastPoint: { bugId: 0, seuilMax: 0, seuilMin: 0 } };

                var formatedLimit = data.reduce((accu, item, index, array) => {
                    if (selectParameter(item) != accu.lastLimit) {
                        point1 = accu.lastPoint;
                        accu.points.push({ ...item, redondancy: [] });
                        accu.lastLimit = selectParameter(item);

                    } else {
                        accu.points[accu.points.length - 1].redondancy.push(item);
                    }
                    accu.lastPoint = item;
                    return accu;
                }, accuInit);
                return formatedLimit.points
            }

            function computePath(data, selectX, selectY) {
                return removeRedondancy(data, selectY).reduce((accu, item, index, array) => {
                    var point1, point2;
                    if (index == 0) {
                        point1 = "0," + yScale(selectY(item.redondancy.last()));
                    }
                    else {
                        point1 = xScale(selectX(item)) - paddingRatio * xScale.step() / 2 + "," + yScale(selectY(item));
                    }
                    if (item.redondancy.length > 0) {
                        point2 = xScale(selectX(item.redondancy.last())) + xScale.bandwidth() + paddingRatio * xScale.step() / 2 + "," + yScale(selectY(item.redondancy.last()))
                    } else {
                        point2 = xScale(selectX(item)) + xScale.bandwidth() + paddingRatio * xScale.step() / 2 + "," + yScale(selectY(item));
                    }
                    accu += point1 + " " + point2 + "\n"
                    return accu;
                }, "");

            }

            function drawAxis(group) {
                group.append("g")
                    .attr("class", "x_axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale))
                    .append("text")
                    .attr("x", width + 40)
                    .attr("y", 15)
                    .attr("text-anchor", "end")
                    .text("id bug")
                    ;

                group.selectAll(".x_axis")
                    .selectAll(".tick text")
                    .attr("text-anchor", "middle")
                    .attr("transform", "translate(" + (-xScale.bandwidth()) + "," + 20 + ") rotate(-65) ")

                group.append("g")
                    .attr("class", "y_axis")  //TODO: add marge
                    .call(d3.axisLeft(yScale).tickFormat(function (d) {
                        return d;
                    })
                        .ticks(10))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "-5.1em")
                    .attr("text-anchor", "end")
                    .text("jours");
            }

            function drawBars(data, group) {
                data[0].y.bar.forEach((item, index, array) => {
                    group.append("g")
                        .selectAll(".bar")
                        .data(data)
                        .enter()
                        .append("rect")
                        .attr("class", "bar")
                        .attr("x", d => xScale(d.x))
                        .attr("width", xScale.bandwidth())
                        .attr("y", d => {
                            const offset = d.y.bar.reduce((accu, item, currentIndex) => {
                                return currentIndex < index
                                    ? accu + item
                                    : accu
                            }, 0);
                            return yScale((d.y.bar[index]) + offset)
                        })
                        .attr("height", d => {
                            return height - yScale(d.y.bar[index])
                        })
                        .attr("fill", d => setColor(d, index))
                })
            }

            function drawPolyline(style, path) {
                svg.select(".graph")
                    .append("polyline")
                    .attr("points", path)
                    .attr("style", style)
            };

            function drawGraph(configGraph) {
                svg.append("text")
                    .attr("class", "title")
                    .attr("transform", "translate(100,0)")
                    .attr("x", 50)
                    .attr("y", 50)
                    .attr("font-size", "24px")
                    .text(configGraph.title);

                var g = svg.append("g")
                    .attr("class", "graph")
                    .attr("transform", "translate(" + 100 + "," + 100 + ")");

                drawAxis(g)
                drawBars(cfg.data, g)
                drawPolyline("fill:none; stroke:" + configGraph.colors.seuilMax + " ;stroke-width:2; stroke-dasharray:12,8", computePath(cfg.data, item => item.x, item => item.y.lines[0]));
                drawPolyline("fill:none; stroke:" + configGraph.colors.seuilMin + " ;stroke-width:2; stroke-dasharray:12,8", computePath(cfg.data, item => item.x, item => item.y.lines[1]));

                d3.selectAll("text").attr("fill", "white");
            };

            function addTooltip() {
                var tooltip = svg.append("g")
                    .attr("class", "tooltip")
                    .style("display", "none");

                tooltip.append("rect")
                    .attr("width", 160)
                    .attr("height", 60)
                    .attr("fill", "white")
                    .style("opacity", 0.6);

                var tooltipText = tooltip.append("text")
                    .attr("x", 15)
                    .attr("dy", "1.2em")
                    .style("text-anchor", "start")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold")
                tspan1 = tooltipText.append("tspan").attr("x", "1.5em").attr("dy", "1.2em")
                tspan2 = tooltipText.append("tspan").attr("x", "1.5em").attr("dy", "1.6em")
                tspan3 = tooltipText.append("tspan").attr("x", "1.5em").attr("dy", "1.8em");
                return tooltip;
            }

            function animateChart() {
                var tooltip = addTooltip()
                d3.selectAll(".bar")
                    .on("mouseover", function () {
                        d3.select(this)
                            .attr("fill", "black")
                    })
                    .on("mouseout", function (a, b) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("fill", d => setColor(d, Math.floor(b / cfg.data.length)))
                    })
                    .on("click", function (a, b) {
                        d3.selectAll(".clickedBar")
                            .attr("class", "bar")
                        d3.select(this)
                            .attr("class", "clickedBar")
                        var xPosition = d3.mouse(this)[0] + 130;
                        var yPosition = d3.mouse(this)[1] + 80;
                        tooltip.style("display", null)
                        tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
                        tspan1.text("Bug: " + a.x)
                        tspan2.text("Lead Time (selected): " + a.y.bar[Math.floor(b / cfg.data.length)])
                        tspan3.text("Lead Time (total): " + a.y.bar.reduce((accu, item) => accu += item))
                    })
                // d3.selectAll(".clickedBar")
                //         .on("click", function (a, b) {
                //         d3.select(this).attr("class", "bar")
                //     })
            }


            drawGraph(cfg);
            animateChart();
        </script>
    </body>

</html>