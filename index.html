<!doctype html>
<html>

<head>
    <style>
        body {
            background-color: #6F6F6E;
            font: arial;
        }

        .line {
            stroke: #460D0F;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <body>
        <div id="myGraph"></div>
        <svg width="600" height="500"></svg>
        <script>
            if (!Array.prototype.last) {
                Array.prototype.last = function () {
                    return this[this.length - 1];
                };
            };

            var data = [{ semaine: "1", nbBug: 42, limite: 30 },
            { semaine: "2", nbBug: 32, limite: 30 },
            { semaine: "3", nbBug: 25, limite: 30 },
            { semaine: "4", nbBug: 12, limite: 30 },
            { semaine: "5", nbBug: 28, limite: 30 },
            { semaine: "6", nbBug: 3, limite: 30 },
            { semaine: "7", nbBug: 7, limite: 15 },
            { semaine: "8", nbBug: 12, limite: 15 },
            { semaine: "9", nbBug: 2, limite: 15 },
            { semaine: "10", nbBug: 1, limite: 10 },
            { semaine: "11", nbBug: 3, limite: 10 },
            { semaine: "12", nbBug: 8, limite: 10 },
            { semaine: "13", nbBug: 11, limite: 10 },
            { semaine: "14", nbBug: 7, limite: 15 },
            { semaine: "15", nbBug: 5, limite: 15 },
            { semaine: "16", nbBug: 9, limite: 10 },
            { semaine: "17", nbBug: 10, limite: 10 },
            { semaine: "18", nbBug: 3, limite: 10 }
            ];

            const paddingRatio = 0.4;
            var svg = d3.select("svg"),
                margin = 200,
                width = svg.attr("width") - margin,
                height = svg.attr("height") - margin,
                xScale = d3.scaleBand().range([0, width]).padding(paddingRatio),
                yScale = d3.scaleLinear().range([height, 0])
                ;

            xScale.domain(data.map(function (d) { return d.semaine; }));
            yScale.domain([0, d3.max(data, function (d) { return d.nbBug; })]);


            function removeRedondancy(data, selectParameter) {
                var accuInit = { points: [], lastLimit: 0, lastPoint: { semaine: 0, limite: 0 } };

                var formatedLimit = data.reduce((accu, item, index, array) => {
                    if (selectParameter(item) != accu.lastLimit) {
                        // add 2 point et set last limit
                        point1 = accu.lastPoint;
                        accu.points.push({ ...item, redondancy: [] });
                        accu.lastLimit = selectParameter(item);

                    } else {
                        accu.points[accu.points.length - 1].redondancy.push(item);
                    }
                    accu.lastPoint = item;
                    return accu;
                }, accuInit);
                return formatedLimit.points
            }

            function formatLimit(data) {
                return removeRedondancy(data, i => i.limite).reduce((accu, item, index, array) => {
                    var point1;
                    if (index == 0) {
                        point1 = "0," + yScale(item.redondancy.last().limite);
                    } else
                        point1 = xScale(item.semaine) - paddingRatio * xScale.step() / 2 + "," + yScale(item.limite);
                    var point2 = xScale(item.redondancy.last().semaine) + xScale.bandwidth() + paddingRatio * xScale.step() / 2 + "," + yScale(item.redondancy.last().limite)
                    accu += point1 + " " + point2 + "\n"
                    return accu;
                }, "");
            }

            console.log(removeRedondancy(data, i => i.limite));
            console.log(formatLimit(data));

            function drawPolyline(ext) {
                svg.select(".graph")
                    .append("polyline")
                    .attr("points", formatLimit(data))
                    .attr("style", "fill:none; stroke:rgb(255,255,0);stroke-width:1")
            };

            function drawGraph(configGraph) {
                svg.append("text")
                    .attr("class", "title")
                    .attr("transform", "translate(100,0)")
                    .attr("x", 50)
                    .attr("y", 50)
                    .attr("font-size", "24px")
                    .text(configGraph.title);

                var g = svg.append("g")
                    .attr("class", "graph")
                    .attr("transform", "translate(" + 100 + "," + 100 + ")");

                drawPolyline({
                    g
                });

                g.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale))
                    .append("text")
                    .attr("y", height - 265)
                    .attr("x", width - 10)
                    .attr("text-anchor", "end")
                    .text("Semaines");

                g.append("g")
                    .attr("class", "axis")
                    .call(d3.axisLeft(yScale).tickFormat(function (d) {
                        return d;
                    })
                        .ticks(10))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "-5.1em")
                    .attr("text-anchor", "end")
                    .text("Bugs");

                g.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return xScale(d.semaine); }) //TODO: fix scale
                    .attr("y", function (d) { return yScale(d.nbBug); })
                    .attr("height", function (d) { return height - yScale(d.nbBug); })
                    .attr("width", xScale.bandwidth())
                    .attr("fill", function (d) {
                        if (d.nbBug < d.limite) {
                            return configGraph.colors.good;
                        }
                        return configGraph.colors.bad;
                    });

                d3.selectAll("text").attr("fill", "white");
            };

            drawGraph({
                data: data,
                title: "Nombre de bugs hebdomadaires:",
                colors: { good: "#C5C4C5", bad: "#BE1622" }
            });

        </script>
    </body>

</html>