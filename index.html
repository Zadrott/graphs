<!doctype html>
<html>

<head>
    <style>
        body {
            background-color: #6F6F6E;
            font: arial;
        }

        svg {
            display: inline-block;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <body>
        <div id="myGraph"></div>
        <svg width="800" height="600"></svg>
        <script>
            if (!Array.prototype.last) {
                Array.prototype.last = function () {
                    return this[this.length - 1];
                };
            };

            var data = [{ bug: "77045", jours: 150, seuilMax: 100, seuilMin: 21 },
            { bug: "77829", jours: 150, seuilMax: 100, seuilMin: 21 },
            { bug: "78287", jours: 140, seuilMax: 100, seuilMin: 21 },
            { bug: "78478", jours: 110, seuilMax: 100, seuilMin: 21 },
            { bug: "78593", jours: 80, seuilMax: 100, seuilMin: 21 },
            { bug: "78624", jours: 75, seuilMax: 100, seuilMin: 21 },
            { bug: "78643", jours: 70, seuilMax: 100, seuilMin: 21 },
            { bug: "78685", jours: 65, seuilMax: 100, seuilMin: 21 },
            { bug: "78713", jours: 61, seuilMax: 100, seuilMin: 21 },
            { bug: "78805", jours: 50, seuilMax: 100, seuilMin: 21 },
            { bug: "78823", jours: 45, seuilMax: 100, seuilMin: 21 },
            { bug: "78848", jours: 42, seuilMax: 100, seuilMin: 21 },
            { bug: "78901", jours: 30, seuilMax: 100, seuilMin: 21 },
            { bug: "78908", jours: 30, seuilMax: 100, seuilMin: 21 },
            { bug: "78934", jours: 25, seuilMax: 100, seuilMin: 21 },
            { bug: "78936", jours: 27, seuilMax: 30, seuilMin: 10 },
            { bug: "78940", jours: 25, seuilMax: 30, seuilMin: 10 },
            { bug: "78964", jours: 21, seuilMax: 100, seuilMin: 21 },
            { bug: "78979", jours: 20, seuilMax: 100, seuilMin: 21 },
            { bug: "78999", jours: 18, seuilMax: 30, seuilMin: 10 },
            { bug: "79000", jours: 17, seuilMax: 100, seuilMin: 21 },
            { bug: "79019", jours: 15, seuilMax: 100, seuilMin: 21 }
            ];

            var cfg = {
                data: data,
                selectedWeek: "15",
                title: "Modaris - Lead Time R&D - Bugs en cours:",
                colors: { good: "#C5C4C5", bad: "#BE1622" }
            };
            const paddingRatio = 0.4;
            var svg = d3.select("svg"),
                margin = 200,
                width = svg.attr("width") - margin,
                height = svg.attr("height") - margin,
                xScale = d3.scaleBand().range([0, width]).padding(paddingRatio),
                yScale = d3.scaleLinear().range([height, 0])
                ;

            xScale.domain(data.map(function (d) { return d.bug; }));
            yScale.domain([0, d3.max(data, function (d) { return d.jours; })]);



            function removeRedondancy(data, selectParameter) {
                var accuInit = { points: [], lastSeuilMax: 0, lastSeuilMin: 0, lastPoint: { bug: 0, seuilMax: 0, seuilMin: 0 } };

                var formatedLimit = data.reduce((accu, item, index, array) => {
                    if (selectParameter(item) != accu.lastLimit) {
                        point1 = accu.lastPoint;
                        accu.points.push({ ...item, redondancy: [] });
                        accu.lastLimit = selectParameter(item);

                    } else {
                        accu.points[accu.points.length - 1].redondancy.push(item);
                    }
                    accu.lastPoint = item;
                    return accu;
                }, accuInit);
                return formatedLimit.points
            }

            function computePath(data, selectX, selectY) {
                return removeRedondancy(data, selectY).reduce((accu, item, index, array) => {
                    var point1;
                    if (index == 0) {
                        point1 = "0," + yScale(selectY(item.redondancy.last()));
                    }
                    else {
                        point1 = xScale(selectX(item)) + paddingRatio * xScale.step() / 2 + "," + yScale(selectY(item));
                    }
                    if (item.redondancy.length > 0) {
                        var point2 = xScale(selectX(item.redondancy.last())) + xScale.bandwidth() + paddingRatio * xScale.step() / 2 + "," + yScale(selectY(item.redondancy.last()))
                        accu += point1 + " " + point2 + "\n"
                    }
                    else {
                        accu += point1 + "\n"
                    }
                    return accu;
                }, "");

            }

            console.log(removeRedondancy(data, i => i.seuilMin));
            console.log(computePath(data, item => item.bug, item => item.seuilMax));

            function drawPolyline(style, path) {
                svg.select(".graph")
                    .append("polyline")
                    .attr("points", path)
                    .attr("style", style)
            };

            function drawGraph(configGraph) {
                svg.append("text")
                    .attr("class", "title")
                    .attr("transform", "translate(100,0)")
                    .attr("x", 50)
                    .attr("y", 50)
                    .attr("font-size", "24px")
                    .text(configGraph.title);

                var g = svg.append("g")
                    .attr("class", "graph")
                    .attr("transform", "translate(" + 100 + "," + 100 + ")");

                drawPolyline("fill:none; stroke:yellow ;stroke-width:2; stroke-dasharray:12,8", computePath(data, item => item.bug, item => item.seuilMax));
                drawPolyline("fill:none; stroke:blue ;stroke-width:2; stroke-dasharray:12,8", computePath(data, item => item.bug, item => item.seuilMin));

                g.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale))
                    .append("text")
                    .attr("y", height - 265)
                    .attr("x", width - 10)
                    .attr("text-anchor", "end")
                    .text("bugs");

                g.append("g")
                    .attr("class", "axis")
                    .call(d3.axisLeft(yScale).tickFormat(function (d) {
                        return d;
                    })
                        .ticks(10))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "-5.1em")
                    .attr("text-anchor", "end")
                    .text("jours");

                g.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return xScale(d.bug); })
                    .attr("y", function (d) { return yScale(d.jours); })
                    .attr("height", function (d) { return height - yScale(d.jours); })
                    .attr("width", xScale.bandwidth())
                    .attr("fill", function (d) {
                        if (d.jours < d.seuilMax) {
                            return configGraph.colors.good;
                        }
                        return configGraph.colors.bad;
                    });

                d3.selectAll("text").attr("fill", "white");

                //   g.append("text")
                //                     .attr("class", "title")
                //                     .attr("transform", "translate(100,0)")
                //                     .attr("x", 50)
                //                     .attr("y", 50)
                //                     .attr("font-size", "24px")
                //                     .text("toto");

                d3.selectAll(".bar")
                    .on("mouseover", function (a, b, c) {
                        d3.select(this)
                            .attr("fill", "black")
                    })
                    .on("mouseout", function () {
                        d3.select(this)
                            .attr("fill", function (d) {
                                if (d.jours < d.seuilMax) {
                                    return cfg.colors.good;
                                }
                                return cfg.colors.bad;
                            })
                    });
            };


            drawGraph(cfg);
        </script>
    </body>

</html>